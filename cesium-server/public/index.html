<!DOCTYPE html>
<html>
<head>
    <title>Cesium Demo</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.82/Build/Cesium/Cesium.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.82/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
</head>
<body>
    <div id="cesiumContainer" style="width: 100%; height: 100vh;"></div>
    <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmODU2NDMyNy0yNDA2LTQwNzQtOGY1Yi1lYWQzOWQ0OTM1YTQiLCJpZCI6MjA0OTc1LCJpYXQiOjE3MTE2MDI0NDR9.Mt6nwYfLzDW7e0432RiWvXBl72JBUuJGyOFV18oRWls'
    const viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider: Cesium.createWorldTerrain(),
    });

     // Define the rectangle boundaries for San Francisco area
    // West, South, East, North in degrees
    const sanFranciscoRectangle = Cesium.Rectangle.fromDegrees(-122.5149, 37.7081, -122.3574, 37.8324);

    // Set the camera view to the San Francisco rectangle
    viewer.camera.setView({
        destination: sanFranciscoRectangle,
        orientation: {
            heading: Cesium.Math.toRadians(0), // East, default value
            pitch: Cesium.Math.toRadians(-15), // looking downwards
            roll: 0.0
        }
    });

    // Optional: Adjust the camera height for better visibility
    viewer.camera.zoomOut(1000);   

    // Set up Socket.IO client to connect to your server
    const socket = io('http://localhost:4000');

    // Create an entity with a path that we will update
    const entity = viewer.entities.add({
        // Define the path graphics for the entity
        path: new Cesium.PathGraphics({
            leadTime: 0, // Time ahead of the entity position to show the path
            trailTime: 60, // Time behind the entity position to show the path
            width: 2,
            material: new Cesium.PolylineGlowMaterialProperty({
                glowPower: 0.3,
                color: Cesium.Color.YELLOW
            }),
        })
    });

    // Initialize an empty array to store positions
    let positions = [];

    // Listen for GPS position updates from the server
    socket.on('gpsPosition', function(data) {
        const position = Cesium.Cartesian3.fromDegrees(data.longitude, data.latitude);
        positions.push(position);

        // Update the entity's position to the latest point
        entity.position = new Cesium.CallbackProperty(function() {
            return positions[positions.length - 1];
        }, false);

        // Update the path's positions
        entity.path.positions = new Cesium.CallbackProperty(function() {
            return positions;
        }, false);

        // Optionally, adjust the viewer to keep the moving entity in view
        viewer.scene.requestRender();
    });
    </script>
</body>
</html>
